!function(e){e(document).on("sowsetupformfield",".siteorigin-widget-field-type-media",(function(i){var t=e(this),a=t.find("> .media-field-wrapper"),s=t.find(".siteorigin-widget-input").not(".media-fallback-external");if(!a.data("initialized")){var n;a.find(".media-upload-button").click((function(i){if(i.preventDefault(),void 0!==wp.media){var a=e(this),n=e(this).data("frame");if(n)return n.open(),!1;(n=wp.media({title:a.data("choose"),library:{type:a.data("library").split(",").map((function(e){return e.trim()}))},button:{text:a.data("update"),close:!1}})).on("open",(function(){var e=n.state().get("selection"),i=t.find('.siteorigin-widget-input[type="hidden"]').val();i&&e.add(wp.media.attachment(i))})),a.data("frame",n),n.on("select",(function(){var e=n.state().get("selection").first().attributes;t.find(".current .thumbnail").attr("title",e.title),s.val(e.id),s.trigger("change",{silent:!0});var i=t.find(".current .thumbnail");void 0!==e.sizes?void 0!==e.sizes.thumbnail?i.attr("src",e.sizes.thumbnail.url).fadeIn():i.attr("src",e.sizes.full.url).fadeIn():i.attr("src",e.icon).fadeIn(),t.find(".media-remove-button").removeClass("remove-hide"),n.close()})),n.open()}})),t.find("a.media-remove-button").click((function(i){i.preventDefault(),s.val(""),s.trigger("change",{silent:!0}),t.find(".current .thumbnail").fadeOut("fast"),e(this).addClass("remove-hide")}));var r=function(){if(n){var e=n.find(".so-widgets-image-results");if(0!==e.length){var i=e.width(),t=Math.floor(i/276),a=(i-276*t)/t+260;e.find(".so-widgets-result-image").css({width:a,height:a/1.4})}}};e(window).resize(r);a.find(".find-image-button").click((function(i){i.preventDefault(),function(){if(!n){(n=e(e("#so-widgets-bundle-tpl-image-search-dialog").html().trim()).appendTo("body")).find(".close").click((function(){n.hide()}));var i,a=n.find(".so-widgets-image-results"),o=function(i,t){n.find(".so-widgets-results-loading").fadeIn("fast"),n.find(".so-widgets-results-loading strong").html(n.find(".so-widgets-results-loading strong").data("loading")),n.find(".so-widgets-results-more").hide(),e.get(ajaxurl,{action:"so_widgets_image_search",q:i,page:t,_sononce:n.find('input[name="_sononce"]').val()},(function(s){s.error?alert(s.message):(a.removeClass("so-loading"),e.each(s.items,(function(i,t){var s=e(e("#so-widgets-bundle-tpl-image-search-result").html().trim()).appendTo(a).addClass("source-"+t.source).find(".so-widgets-result-image");s.css("background-image","url("+t.thumbnail+")"),s.data("thumbnail",t.thumbnail),s.data("preview",t.preview),t.url&&s.attr({href:t.url,target:"_blank"}),t.full_url&&(s.data({full_url:t.full_url,import_signature:t.import_signature}),s.attr("href",t.full_url)),"shutterstock"===t.source&&s.append(e("#so-widgets-bundle-tpl-image-search-result-sponsored").html())})),1===t&&(n.find("#so-widgets-image-search-suggestions ul").empty(),e.each(s.keywords,(function(i,t){n.find("#so-widgets-image-search-suggestions").show(),n.find("#so-widgets-image-search-suggestions ul").append(e("<li></li>").append(e('<a href="#"></a>').html(t).data("keyword",t)))}))),n.find(".so-widgets-results-loading").fadeOut("fast"),r(),n.find(".so-widgets-results-more").show().find("button").data({query:i,page:t+1}))}))};n.find("#so-widgets-image-search-form").submit((function(e){e.preventDefault();var i=n.find(".so-widgets-search-input").val();a.empty(),""!==i&&o(i,1)})),n.on("click",".so-keywords-list a",(function(i){i.preventDefault();var t=e(this).blur();n.find(".so-widgets-search-input").val(t.data("keyword")),n.find("#so-widgets-image-search-form").submit()})),n.find(".so-widgets-results-more button").click((function(){var i=e(this);o(i.data("query"),i.data("page"))})),n.on("click",".so-widgets-result-image",(function(i){var a=e(this);if(a.data("full_url")&&(i.preventDefault(),confirm(n.data("confirm-import")))){n.addClass("so-widgets-importing");var r=e("#post_ID").val();null===r&&(r=""),e.get(ajaxurl,{action:"so_widgets_image_import",full_url:a.data("full_url"),import_signature:a.data("import_signature"),post_id:r,_sononce:n.find('input[name="_sononce"]').val()},(function(e){n.find("#so-widgets-image-search-frame").removeClass("so-widgets-importing"),!1===e.error?(n.hide(),n.find(".so-widgets-results-loading").hide(),s.val(e.attachment_id).trigger("change",{silent:!0}),t.find(".current .thumbnail").attr("src",e.thumb).fadeIn(),t.find(".media-remove-button").removeClass("remove-hide")):(alert(e.message),n.find(".so-widgets-results-loading").hide())})),n.find(".so-widgets-results-loading").fadeIn("fast"),n.find(".so-widgets-results-loading strong").html(n.find(".so-widgets-results-loading strong").data("importing")),n.find(".so-widgets-results-more").hide(),n.find("#so-widgets-image-search-frame").addClass("so-widgets-importing")}}));var d,l,u=n.find(".so-widgets-preview-window");n.on("mouseenter",".so-widgets-result-image",(function(){var t=e(this),a=t.data("preview");clearTimeout(i),i=setTimeout((function(){var i=1,s=1;a[1]>.33*e(window).outerWidth()&&(i=.33*e(window).outerWidth()/a[1]),a[2]>.5*e(window).outerHeight()&&(s=.5*e(window).outerHeight()/a[2]);var r=Math.min(i,s);r>1&&(r=1),u.show().find(".so-widgets-preview-window-inside").css({"background-image":"url("+t.data("thumbnail")+")",width:a[1]*r,height:a[2]*r}).append(e("<img />").attr("src",a[0])),n.trigger("mousemove")}),1e3)})).on("mouseleave",".so-widgets-result-image",(function(){u.hide().find("img").remove(),clearTimeout(i)})),n.on("mousemove",(function(i){if(i.clientX&&(d=i.clientX),i.clientY&&(l=i.clientY),u.is(":visible")){var t=u.outerHeight(),a=u.outerWidth(),s=e(window).outerHeight(),n=e(window).outerWidth(),r=l-t/2;r=Math.max(r,10),r=Math.min(r,s-10-t);var o=d<n/2?d+15:d-15-a;u.css({top:r,left:o})}}))}n.show(),n.find(".so-widgets-search-input").focus()}()})),s.change((function(e,i){if(!i||!i.silent){var a=s.val();if(a){var n=t.find(".current .thumbnail"),r=wp.media.attachment(a);r.fetch().done((function(){if(r.has("sizes")){var e=r.get("sizes");void 0!==e.thumbnail?n.attr("src",e.thumbnail.url).fadeIn():n.attr("src",e.full.url).fadeIn()}else n.attr("src",r.get("icon")).fadeIn();t.find(".media-remove-button").removeClass("remove-hide")}))}else t.find("a.media-remove-button").click()}})),a.data("initialized",!0)}}))}(jQuery);